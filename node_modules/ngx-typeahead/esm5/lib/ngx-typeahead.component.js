import { __decorate } from "tslib";
import { HttpClient } from '@angular/common/http';
import { ChangeDetectorRef, Component, ElementRef, EventEmitter, HostListener, Input, OnDestroy, OnInit, Output, TemplateRef, ViewChild, ViewContainerRef, } from '@angular/core';
import { of, Subject } from 'rxjs';
import { concat, debounceTime, distinctUntilChanged, filter, map, switchMap, tap, } from 'rxjs/operators';
import { Key } from './models';
import { createParamsForQuery, hasCharacters, isEnterKey, isEscapeKey, isIndexActive, resolveApiMethod, resolveNextIndex, toFormControlValue, toJsonpFinalResults, toJsonpSingleResult, validateArrowKeys, validateNonCharKeyCode, resolveItemValue, NO_INDEX, } from './ngx-typeahead.utils';
/*
 using an external template:
 <input [taItemTpl]="itemTpl" >

  <ng-template #itemTpl let-result>
    <strong>MY {{ result.result }}</strong>
  </ng-template>
*/
var NgxTypeAheadComponent = /** @class */ (function () {
    function NgxTypeAheadComponent(element, viewContainer, http, cdr) {
        this.element = element;
        this.viewContainer = viewContainer;
        this.http = http;
        this.cdr = cdr;
        this.showSuggestions = false;
        this.results = [];
        this.taUrl = '';
        this.taParams = {};
        this.taQueryParam = 'q';
        this.taApi = 'jsonp';
        this.taApiMethod = 'get';
        this.taList = [];
        this.taListItemField = [];
        this.taListItemLabel = '';
        this.taDebounce = 300;
        this.taAllowEmpty = false;
        this.taCaseSensitive = false;
        this.taDisplayOnFocus = false;
        this.taSelected = new EventEmitter();
        this.suggestionIndex = 0;
        this.subscriptions = [];
        this.activeResult = '';
        this.searchQuery = '';
        this.selectedItem = {};
        this.resultsAsItems = [];
        this.keydown$ = new Subject();
        this.keyup$ = new Subject();
    }
    NgxTypeAheadComponent.prototype.handleEsc = function (event) {
        if (isEscapeKey(event)) {
            this.hideSuggestions();
            event.preventDefault();
        }
        this.keydown$.next(event);
    };
    NgxTypeAheadComponent.prototype.onkeyup = function (event) {
        event.preventDefault();
        event.stopPropagation();
        this.keyup$.next(event);
    };
    NgxTypeAheadComponent.prototype.onClick = function () {
        if (this.taDisplayOnFocus) {
            this.displaySuggestions();
        }
    };
    NgxTypeAheadComponent.prototype.ngOnInit = function () {
        this.filterEnterEvent(this.keydown$);
        this.listenAndSuggest(this.keyup$);
        this.navigateWithArrows(this.keydown$);
        this.renderTemplate();
    };
    NgxTypeAheadComponent.prototype.ngOnDestroy = function () {
        this.keydown$.complete();
        this.keyup$.complete();
    };
    NgxTypeAheadComponent.prototype.renderTemplate = function () {
        if (!this.suggestionsTplRef) {
            console.error('NO NGXTA Template Found. Requires NG9');
            return;
        }
        this.viewContainer.createEmbeddedView(this.suggestionsTplRef);
        this.cdr.markForCheck();
    };
    NgxTypeAheadComponent.prototype.listenAndSuggest = function (obs) {
        var _this = this;
        obs
            .pipe(
        // tslint:disable-next-line: deprecation
        filter(function (e) { return validateNonCharKeyCode(e.code); }), map(toFormControlValue), debounceTime(this.taDebounce), 
        // tslint:disable-next-line: deprecation
        concat(), distinctUntilChanged(), filter(function (query) { return _this.taAllowEmpty || hasCharacters(query); }), tap(function (query) { return (_this.searchQuery = query); }), switchMap(function (query) { return _this.suggest(query); }))
            .subscribe(function (results) {
            _this.assignResults(results);
            // this.updateIndex(Key.ArrowDown);
            _this.displaySuggestions();
        });
    };
    NgxTypeAheadComponent.prototype.assignResults = function (results) {
        var labelForDisplay = this.taListItemLabel;
        this.resultsAsItems = results;
        this.results = results.map(function (item) {
            return labelForDisplay ? item[labelForDisplay] : item;
        });
        this.suggestionIndex = NO_INDEX;
        if (!results || !results.length) {
            this.activeResult = this.searchQuery;
        }
    };
    NgxTypeAheadComponent.prototype.filterEnterEvent = function (elementObs) {
        var _this = this;
        elementObs.pipe(filter(isEnterKey)).subscribe(function (event) {
            _this.handleSelectSuggestion(_this.activeResult);
        });
    };
    NgxTypeAheadComponent.prototype.navigateWithArrows = function (elementObs) {
        var _this = this;
        elementObs
            .pipe(filter(function (e) { return validateArrowKeys(e.keyCode); }), map(function (e) { return e.keyCode; }))
            .subscribe(function (keyCode) {
            _this.updateIndex(keyCode);
            _this.displaySuggestions();
        });
    };
    NgxTypeAheadComponent.prototype.updateIndex = function (keyCode) {
        this.suggestionIndex = resolveNextIndex(this.suggestionIndex, keyCode === Key.ArrowDown, this.results.length);
    };
    NgxTypeAheadComponent.prototype.displaySuggestions = function () {
        this.showSuggestions = true;
        this.cdr.markForCheck();
    };
    NgxTypeAheadComponent.prototype.suggest = function (query) {
        return this.taList.length
            ? this.createListSource(this.taList, query)
            : this.request(query);
    };
    /**
     * peforms a jsonp/http request to search with query and params
     * @param query the query to search from the remote source
     */
    NgxTypeAheadComponent.prototype.request = function (query) {
        var url = this.taUrl;
        var searchConfig = createParamsForQuery(query, this.taQueryParam, this.taParams);
        var options = {
            params: searchConfig,
        };
        var isJsonpApi = this.taApi === 'jsonp';
        return isJsonpApi
            ? this.requestJsonp(url, options, this.taCallbackParamValue)
            : this.requestHttp(url, options);
    };
    NgxTypeAheadComponent.prototype.requestHttp = function (url, options) {
        var apiMethod = resolveApiMethod(this.taApiMethod);
        return this.http[apiMethod](url, options);
    };
    NgxTypeAheadComponent.prototype.requestJsonp = function (url, options, callback) {
        if (callback === void 0) { callback = 'callback'; }
        var params = options.params.toString();
        return this.http
            .jsonp(url + "?" + params, callback)
            .pipe(map(toJsonpSingleResult), map(toJsonpFinalResults));
    };
    NgxTypeAheadComponent.prototype.markIsActive = function (index, result) {
        var isActive = isIndexActive(index, this.suggestionIndex);
        if (isActive) {
            this.activeResult = result;
        }
        return isActive;
    };
    NgxTypeAheadComponent.prototype.handleSelectionClick = function (suggestion, index) {
        this.suggestionIndex = index;
        this.handleSelectSuggestion(suggestion);
    };
    NgxTypeAheadComponent.prototype.handleSelectSuggestion = function (suggestion) {
        var result = this.resultsAsItems.length
            ? this.resultsAsItems[this.suggestionIndex]
            : suggestion;
        this.hideSuggestions();
        var resolvedResult = this.suggestionIndex === NO_INDEX ? this.searchQuery : result;
        this.taSelected.emit(resolvedResult);
    };
    NgxTypeAheadComponent.prototype.hideSuggestions = function () {
        this.showSuggestions = false;
    };
    NgxTypeAheadComponent.prototype.hasItemTemplate = function () {
        return this.taItemTpl !== undefined;
    };
    NgxTypeAheadComponent.prototype.createListSource = function (list, query) {
        var _this = this;
        var sanitizedQuery = this.taCaseSensitive ? query : query.toLowerCase();
        var fieldsToExtract = this.taListItemField;
        return of(list.filter(function (item) {
            return resolveItemValue(item, fieldsToExtract, _this.taCaseSensitive).includes(sanitizedQuery);
        }));
    };
    NgxTypeAheadComponent.ctorParameters = function () { return [
        { type: ElementRef },
        { type: ViewContainerRef },
        { type: HttpClient },
        { type: ChangeDetectorRef }
    ]; };
    __decorate([
        Input()
    ], NgxTypeAheadComponent.prototype, "taItemTpl", void 0);
    __decorate([
        Input()
    ], NgxTypeAheadComponent.prototype, "taUrl", void 0);
    __decorate([
        Input()
    ], NgxTypeAheadComponent.prototype, "taParams", void 0);
    __decorate([
        Input()
    ], NgxTypeAheadComponent.prototype, "taQueryParam", void 0);
    __decorate([
        Input()
    ], NgxTypeAheadComponent.prototype, "taCallbackParamValue", void 0);
    __decorate([
        Input()
    ], NgxTypeAheadComponent.prototype, "taApi", void 0);
    __decorate([
        Input()
    ], NgxTypeAheadComponent.prototype, "taApiMethod", void 0);
    __decorate([
        Input()
    ], NgxTypeAheadComponent.prototype, "taList", void 0);
    __decorate([
        Input()
    ], NgxTypeAheadComponent.prototype, "taListItemField", void 0);
    __decorate([
        Input()
    ], NgxTypeAheadComponent.prototype, "taListItemLabel", void 0);
    __decorate([
        Input()
    ], NgxTypeAheadComponent.prototype, "taDebounce", void 0);
    __decorate([
        Input()
    ], NgxTypeAheadComponent.prototype, "taAllowEmpty", void 0);
    __decorate([
        Input()
    ], NgxTypeAheadComponent.prototype, "taCaseSensitive", void 0);
    __decorate([
        Input()
    ], NgxTypeAheadComponent.prototype, "taDisplayOnFocus", void 0);
    __decorate([
        Output()
    ], NgxTypeAheadComponent.prototype, "taSelected", void 0);
    __decorate([
        ViewChild(TemplateRef, { static: true })
    ], NgxTypeAheadComponent.prototype, "suggestionsTplRef", void 0);
    __decorate([
        HostListener('keydown', ['$event'])
    ], NgxTypeAheadComponent.prototype, "handleEsc", null);
    __decorate([
        HostListener('keyup', ['$event'])
    ], NgxTypeAheadComponent.prototype, "onkeyup", null);
    __decorate([
        HostListener('click')
    ], NgxTypeAheadComponent.prototype, "onClick", null);
    NgxTypeAheadComponent = __decorate([
        Component({
            // tslint:disable-next-line: component-selector
            selector: 'ngx-typeahead, [ngxTypeahead]',
            template: "\n    <ng-template #suggestionsTplRef>\n      <section class=\"ta-results list-group\" *ngIf=\"showSuggestions\">\n        <div class=\"ta-backdrop\" (click)=\"hideSuggestions()\"></div>\n        <button\n          type=\"button\"\n          class=\"ta-item list-group-item\"\n          *ngFor=\"let result of results; let i = index\"\n          [class.active]=\"markIsActive(i, result)\"\n          (click)=\"handleSelectionClick(result, i)\"\n        >\n          <span *ngIf=\"!taItemTpl\"\n            ><i class=\"fa fa-search\"></i> {{ result }}</span\n          >\n          <ng-template\n            [ngTemplateOutlet]=\"taItemTpl\"\n            [ngTemplateOutletContext]=\"{\n              $implicit: { result: result, index: i }\n            }\"\n          ></ng-template>\n        </button>\n      </section>\n    </ng-template>\n  ",
            styles: ["\n      .ta-results {\n        position: absolute;\n      }\n      .ta-backdrop {\n        bottom: 0;\n        left: 0;\n        position: fixed;\n        right: 0;\n        top: 0;\n        z-index: 1;\n      }\n      .ta-item {\n        position: relative;\n        z-index: 2;\n        display: block;\n      }\n    "]
        })
    ], NgxTypeAheadComponent);
    return NgxTypeAheadComponent;
}());
export { NgxTypeAheadComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmd4LXR5cGVhaGVhZC5jb21wb25lbnQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9uZ3gtdHlwZWFoZWFkLyIsInNvdXJjZXMiOlsibGliL25neC10eXBlYWhlYWQuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFDbEQsT0FBTyxFQUNMLGlCQUFpQixFQUNqQixTQUFTLEVBQ1QsVUFBVSxFQUNWLFlBQVksRUFDWixZQUFZLEVBQ1osS0FBSyxFQUNMLFNBQVMsRUFDVCxNQUFNLEVBQ04sTUFBTSxFQUNOLFdBQVcsRUFDWCxTQUFTLEVBQ1QsZ0JBQWdCLEdBQ2pCLE1BQU0sZUFBZSxDQUFDO0FBQ3ZCLE9BQU8sRUFBRSxFQUFFLEVBQWMsT0FBTyxFQUFnQixNQUFNLE1BQU0sQ0FBQztBQUM3RCxPQUFPLEVBQ0wsTUFBTSxFQUNOLFlBQVksRUFDWixvQkFBb0IsRUFDcEIsTUFBTSxFQUNOLEdBQUcsRUFDSCxTQUFTLEVBRVQsR0FBRyxHQUNKLE1BQU0sZ0JBQWdCLENBQUM7QUFDeEIsT0FBTyxFQUFFLEdBQUcsRUFBRSxNQUFNLFVBQVUsQ0FBQztBQUMvQixPQUFPLEVBQ0wsb0JBQW9CLEVBQ3BCLGFBQWEsRUFDYixVQUFVLEVBQ1YsV0FBVyxFQUNYLGFBQWEsRUFDYixnQkFBZ0IsRUFDaEIsZ0JBQWdCLEVBQ2hCLGtCQUFrQixFQUNsQixtQkFBbUIsRUFDbkIsbUJBQW1CLEVBQ25CLGlCQUFpQixFQUNqQixzQkFBc0IsRUFDdEIsZ0JBQWdCLEVBQ2hCLFFBQVEsR0FDVCxNQUFNLHVCQUF1QixDQUFDO0FBRS9COzs7Ozs7O0VBT0U7QUFpREY7SUFnREUsK0JBQ1UsT0FBbUIsRUFDbkIsYUFBK0IsRUFDL0IsSUFBZ0IsRUFDaEIsR0FBc0I7UUFIdEIsWUFBTyxHQUFQLE9BQU8sQ0FBWTtRQUNuQixrQkFBYSxHQUFiLGFBQWEsQ0FBa0I7UUFDL0IsU0FBSSxHQUFKLElB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RUFBRTs2REFDcUM7SUFHOUM7UUFEQyxTQUFTLENBQUMsV0FBVyxFQUFFLEVBQUMsTUFBTSxFQUFFLElBQUksRUFBQyxDQUFDO29FQUNIO0lBbUJwQztRQURDLFlBQVksQ0FBQyxTQUFTLEVBQUUsQ0FBQyxRQUFRLENBQUMsQ0FBQzswREFPbkM7SUFHRDtRQURDLFlBQVksQ0FBQyxPQUFPLEVBQUUsQ0FBQyxRQUFRLENBQUMsQ0FBQzt3REFLakM7SUFHRDtRQURDLFlBQVksQ0FBQyxPQUFPLENBQUM7d0RBS3JCO0lBNUVVLHFCQUFxQjtRQWhEakMsU0FBUyxDQUFDO1lBQ1QsK0NBQStDO1lBQy9DLFFBQVEsRUFBRSwrQkFBK0I7WUFxQnpDLFFBQVEsRUFBRSw0MEJBdUJUO3FCQTFDQyxpVUFpQkM7U0EwQkosQ0FBQztPQUNXLHFCQUFxQixDQXFQakM7SUFBRCw0QkFBQztDQUFBLEFBclBELElBcVBDO1NBclBZLHFCQUFxQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEh0dHBDbGllbnQgfSBmcm9tICdAYW5ndWxhci9jb21tb24vaHR0cCc7XG5pbXBvcnQge1xuICBDaGFuZ2VEZXRlY3RvclJlZixcbiAgQ29tcG9uZW50LFxuICBFbGVtZW50UmVmLFxuICBFdmVudEVtaXR0ZXIsXG4gIEhvc3RMaXN0ZW5lcixcbiAgSW5wdXQsXG4gIE9uRGVzdHJveSxcbiAgT25Jbml0LFxuICBPdXRwdXQsXG4gIFRlbXBsYXRlUmVmLFxuICBWaWV3Q2hpbGQsXG4gIFZpZXdDb250YWluZXJSZWYsXG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgb2YsIE9ic2VydmFibGUsIFN1YmplY3QsIFN1YnNjcmlwdGlvbiB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHtcbiAgY29uY2F0LFxuICBkZWJvdW5jZVRpbWUsXG4gIGRpc3RpbmN0VW50aWxDaGFuZ2VkLFxuICBmaWx0ZXIsXG4gIG1hcCxcbiAgc3dpdGNoTWFwLFxuICB0YWtlVW50aWwsXG4gIHRhcCxcbn0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgS2V5IH0gZnJvbSAnLi9tb2RlbHMnO1xuaW1wb3J0IHtcbiAgY3JlYXRlUGFyYW1zRm9yUXVlcnksXG4gIGhhc0NoYXJhY3RlcnMsXG4gIGlzRW50ZXJLZXksXG4gIGlzRXNjYXBlS2V5LFxuICBpc0luZGV4QWN0aXZlLFxuICByZXNvbHZlQXBpTWV0aG9kLFxuICByZXNvbHZlTmV4dEluZGV4LFxuICB0b0Zvcm1Db250cm9sVmFsdWUsXG4gIHRvSnNvbnBGaW5hbFJlc3VsdHMsXG4gIHRvSnNvbnBTaW5nbGVSZXN1bHQsXG4gIHZhbGlkYXRlQXJyb3dLZXlzLFxuICB2YWxpZGF0ZU5vbkNoYXJLZXlDb2RlLFxuICByZXNvbHZlSXRlbVZhbHVlLFxuICBOT19JTkRFWCxcbn0gZnJvbSAnLi9uZ3gtdHlwZWFoZWFkLnV0aWxzJztcblxuLypcbiB1c2luZyBhbiBleHRlcm5hbCB0ZW1wbGF0ZTpcbiA8aW5wdXQgW3RhSXRlbVRwbF09XCJpdGVtVHBsXCIgPlxuXG4gIDxuZy10ZW1wbGF0ZSAjaXRlbVRwbCBsZXQtcmVzdWx0PlxuICAgIDxzdHJvbmc+TVkge3sgcmVzdWx0LnJlc3VsdCB9fTwvc3Ryb25nPlxuICA8L25nLXRlbXBsYXRlPlxuKi9cbkBDb21wb25lbnQoe1xuICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6IGNvbXBvbmVudC1zZWxlY3RvclxuICBzZWxlY3RvcjogJ25neC10eXBlYWhlYWQsIFtuZ3hUeXBlYWhlYWRdJyxcbiAgc3R5bGVzOiBbXG4gICAgYFxuICAgICAgLnRhLXJlc3VsdHMge1xuICAgICAgICBwb3NpdGlvbjogYWJzb2x1dGU7XG4gICAgICB9XG4gICAgICAudGEtYmFja2Ryb3Age1xuICAgICAgICBib3R0b206IDA7XG4gICAgICAgIGxlZnQ6IDA7XG4gICAgICAgIHBvc2l0aW9uOiBmaXhlZDtcbiAgICAgICAgcmlnaHQ6IDA7XG4gICAgICAgIHRvcDogMDtcbiAgICAgICAgei1pbmRleDogMTtcbiAgICAgIH1cbiAgICAgIC50YS1pdGVtIHtcbiAgICAgICAgcG9zaXRpb246IHJlbGF0aXZlO1xuICAgICAgICB6LWluZGV4OiAyO1xuICAgICAgICBkaXNwbGF5OiBibG9jaztcbiAgICAgIH1cbiAgICBgLFxuICBdLFxuICB0ZW1wbGF0ZTogYFxuICAgIDxuZy10ZW1wbGF0ZSAjc3VnZ2VzdGlvbnNUcGxSZWY+XG4gICAgICA8c2VjdGlvbiBjbGFzcz1cInRhLXJlc3VsdHMgbGlzdC1ncm91cFwiICpuZ0lmPVwic2hvd1N1Z2dlc3Rpb25zXCI+XG4gICAgICAgIDxkaXYgY2xhc3M9XCJ0YS1iYWNrZHJvcFwiIChjbGljayk9XCJoaWRlU3VnZ2VzdGlvbnMoKVwiPjwvZGl2PlxuICAgICAgICA8YnV0dG9uXG4gICAgICAgICAgdHlwZT1cImJ1dHRvblwiXG4gICAgICAgICAgY2xhc3M9XCJ0YS1pdGVtIGxpc3QtZ3JvdXAtaXRlbVwiXG4gICAgICAgICAgKm5nRm9yPVwibGV0IHJlc3VsdCBvZiByZXN1bHRzOyBsZXQgaSA9IGluZGV4XCJcbiAgICAgICAgICBbY2xhc3MuYWN0aXZlXT1cIm1hcmtJc0FjdGl2ZShpLCByZXN1bHQpXCJcbiAgICAgICAgICAoY2xpY2spPVwiaGFuZGxlU2VsZWN0aW9uQ2xpY2socmVzdWx0LCBpKVwiXG4gICAgICAgID5cbiAgICAgICAgICA8c3BhbiAqbmdJZj1cIiF0YUl0ZW1UcGxcIlxuICAgICAgICAgICAgPjxpIGNsYXNzPVwiZmEgZmEtc2VhcmNoXCI+PC9pPiB7eyByZXN1bHQgfX08L3NwYW5cbiAgICAgICAgICA+XG4gICAgICAgICAgPG5nLXRlbXBsYXRlXG4gICAgICAgICAgICBbbmdUZW1wbGF0ZU91dGxldF09XCJ0YUl0ZW1UcGxcIlxuICAgICAgICAgICAgW25nVGVtcGxhdGVPdXRsZXRDb250ZXh0XT1cIntcbiAgICAgICAgICAgICAgJGltcGxpY2l0OiB7IHJlc3VsdDogcmVzdWx0LCBpbmRleDogaSB9XG4gICAgICAgICAgICB9XCJcbiAgICAgICAgICA+PC9uZy10ZW1wbGF0ZT5cbiAgICAgICAgPC9idXR0b24+XG4gICAgICA8L3NlY3Rpb24+XG4gICAgPC9uZy10ZW1wbGF0ZT5cbiAgYCxcbn0pXG5leHBvcnQgY2xhc3MgTmd4VHlwZUFoZWFkQ29tcG9uZW50IGltcGxlbWVudHMgT25Jbml0LCBPbkRlc3Ryb3kge1xuICBzaG93U3VnZ2VzdGlvbnMgPSBmYWxzZTtcbiAgcmVzdWx0czogc3RyaW5nW10gPSBbXTtcblxuICBASW5wdXQoKVxuICB0YUl0ZW1UcGwhOiBUZW1wbGF0ZVJlZjxhbnk+O1xuICBASW5wdXQoKVxuICB0YVVybCA9ICcnO1xuICBASW5wdXQoKVxuICB0YVBhcmFtcyA9IHt9O1xuICBASW5wdXQoKVxuICB0YVF1ZXJ5UGFyYW0gPSAncSc7XG4gIEBJbnB1dCgpXG4gIHRhQ2FsbGJhY2tQYXJhbVZhbHVlO1xuICBASW5wdXQoKVxuICB0YUFwaSA9ICdqc29ucCc7XG4gIEBJbnB1dCgpXG4gIHRhQXBpTWV0aG9kID0gJ2dldCc7XG4gIEBJbnB1dCgpXG4gIHRhTGlzdCA9IFtdO1xuICBASW5wdXQoKVxuICB0YUxpc3RJdGVtRmllbGQgPSBbXTtcbiAgQElucHV0KClcbiAgdGFMaXN0SXRlbUxhYmVsID0gJyc7XG4gIEBJbnB1dCgpXG4gIHRhRGVib3VuY2UgPSAzMDA7XG4gIEBJbnB1dCgpXG4gIHRhQWxsb3dFbXB0eSA9IGZhbHNlO1xuICBASW5wdXQoKVxuICB0YUNhc2VTZW5zaXRpdmUgPSBmYWxzZTtcbiAgQElucHV0KClcbiAgdGFEaXNwbGF5T25Gb2N1cyA9IGZhbHNlO1xuXG4gIEBPdXRwdXQoKVxuICB0YVNlbGVjdGVkID0gbmV3IEV2ZW50RW1pdHRlcjxzdHJpbmcgfCBhbnk+KCk7XG5cbiAgQFZpZXdDaGlsZChUZW1wbGF0ZVJlZiwge3N0YXRpYzogdHJ1ZX0pXG4gIHN1Z2dlc3Rpb25zVHBsUmVmOiBUZW1wbGF0ZVJlZjxhbnk+O1xuXG4gIHByaXZhdGUgc3VnZ2VzdGlvbkluZGV4ID0gMDtcbiAgcHJpdmF0ZSBzdWJzY3JpcHRpb25zOiBTdWJzY3JpcHRpb25bXSA9IFtdO1xuICBwcml2YXRlIGFjdGl2ZVJlc3VsdCA9ICcnO1xuICBwcml2YXRlIHNlYXJjaFF1ZXJ5ID0gJyc7XG4gIHByaXZhdGUgc2VsZWN0ZWRJdGVtOiBhbnkgPSB7fTtcbiAgcHJpdmF0ZSByZXN1bHRzQXNJdGVtczogYW55W10gPSBbXTtcbiAgcHJpdmF0ZSBrZXlkb3duJCA9IG5ldyBTdWJqZWN0PEtleWJvYXJkRXZlbnQ+KCk7XG4gIHByaXZhdGUga2V5dXAkID0gbmV3IFN1YmplY3Q8S2V5Ym9hcmRFdmVudD4oKTtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIGVsZW1lbnQ6IEVsZW1lbnRSZWYsXG4gICAgcHJpdmF0ZSB2aWV3Q29udGFpbmVyOiBWaWV3Q29udGFpbmVyUmVmLFxuICAgIHByaXZhdGUgaHR0cDogSHR0cENsaWVudCxcbiAgICBwcml2YXRlIGNkcjogQ2hhbmdlRGV0ZWN0b3JSZWZcbiAgKSB7fVxuXG4gIEBIb3N0TGlzdGVuZXIoJ2tleWRvd24nLCBbJyRldmVudCddKVxuICBoYW5kbGVFc2MoZXZlbnQ6IEtleWJvYXJkRXZlbnQpIHtcbiAgICBpZiAoaXNFc2NhcGVLZXkoZXZlbnQpKSB7XG4gICAgICB0aGlzLmhpZGVTdWdnZXN0aW9ucygpO1xuICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcbiAgICB9XG4gICAgdGhpcy5rZXlkb3duJC5uZXh0KGV2ZW50KTtcbiAgfVxuXG4gIEBIb3N0TGlzdGVuZXIoJ2tleXVwJywgWyckZXZlbnQnXSlcbiAgb25rZXl1cChldmVudDogS2V5Ym9hcmRFdmVudCkge1xuICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG4gICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgdGhpcy5rZXl1cCQubmV4dChldmVudCk7XG4gIH1cblxuICBASG9zdExpc3RlbmVyKCdjbGljaycpXG4gIG9uQ2xpY2soKSB7XG4gICAgaWYgKHRoaXMudGFEaXNwbGF5T25Gb2N1cykge1xuICAgICAgdGhpcy5kaXNwbGF5U3VnZ2VzdGlvbnMoKTtcbiAgICB9XG4gIH1cblxuICBuZ09uSW5pdCgpIHtcbiAgICB0aGlzLmZpbHRlckVudGVyRXZlbnQodGhpcy5rZXlkb3duJCk7XG4gICAgdGhpcy5saXN0ZW5BbmRTdWdnZXN0KHRoaXMua2V5dXAkKTtcbiAgICB0aGlzLm5hdmlnYXRlV2l0aEFycm93cyh0aGlzLmtleWRvd24kKTtcbiAgICB0aGlzLnJlbmRlclRlbXBsYXRlKCk7XG4gIH1cblxuICBuZ09uRGVzdHJveSgpIHtcbiAgICB0aGlzLmtleWRvd24kLmNvbXBsZXRlKCk7XG4gICAgdGhpcy5rZXl1cCQuY29tcGxldGUoKTtcbiAgfVxuXG4gIHJlbmRlclRlbXBsYXRlKCkge1xuICAgIGlmICghdGhpcy5zdWdnZXN0aW9uc1RwbFJlZikge1xuICAgICAgY29uc29sZS5lcnJvcignTk8gTkdYVEEgVGVtcGxhdGUgRm91bmQuIFJlcXVpcmVzIE5HOScpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB0aGlzLnZpZXdDb250YWluZXIuY3JlYXRlRW1iZWRkZWRWaWV3KHRoaXMuc3VnZ2VzdGlvbnNUcGxSZWYpO1xuICAgIHRoaXMuY2RyLm1hcmtGb3JDaGVjaygpO1xuICB9XG5cbiAgbGlzdGVuQW5kU3VnZ2VzdChvYnM6IFN1YmplY3Q8S2V5Ym9hcmRFdmVudD4pIHtcbiAgICBvYnNcbiAgICAgIC5waXBlKFxuICAgICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6IGRlcHJlY2F0aW9uXG4gICAgICAgIGZpbHRlcigoZTogS2V5Ym9hcmRFdmVudCkgPT4gdmFsaWRhdGVOb25DaGFyS2V5Q29kZShlLmNvZGUpKSxcbiAgICAgICAgbWFwKHRvRm9ybUNvbnRyb2xWYWx1ZSksXG4gICAgICAgIGRlYm91bmNlVGltZSh0aGlzLnRhRGVib3VuY2UpLFxuICAgICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6IGRlcHJlY2F0aW9uXG4gICAgICAgIGNvbmNhdCgpLFxuICAgICAgICBkaXN0aW5jdFVudGlsQ2hhbmdlZCgpLFxuICAgICAgICBmaWx0ZXIoKHF1ZXJ5OiBzdHJpbmcpID0+IHRoaXMudGFBbGxvd0VtcHR5IHx8IGhhc0NoYXJhY3RlcnMocXVlcnkpKSxcbiAgICAgICAgdGFwKChxdWVyeTogc3RyaW5nKSA9PiAodGhpcy5zZWFyY2hRdWVyeSA9IHF1ZXJ5KSksXG4gICAgICAgIHN3aXRjaE1hcCgocXVlcnk6IHN0cmluZykgPT4gdGhpcy5zdWdnZXN0KHF1ZXJ5KSlcbiAgICAgIClcbiAgICAgIC5zdWJzY3JpYmUoKHJlc3VsdHM6IHN0cmluZ1tdIHwgYW55KSA9PiB7XG4gICAgICAgIHRoaXMuYXNzaWduUmVzdWx0cyhyZXN1bHRzKTtcbiAgICAgICAgLy8gdGhpcy51cGRhdGVJbmRleChLZXkuQXJyb3dEb3duKTtcbiAgICAgICAgdGhpcy5kaXNwbGF5U3VnZ2VzdGlvbnMoKTtcbiAgICAgIH0pO1xuICB9XG5cbiAgYXNzaWduUmVzdWx0cyhyZXN1bHRzOiBhbnlbXSkge1xuICAgIGNvbnN0IGxhYmVsRm9yRGlzcGxheSA9IHRoaXMudGFMaXN0SXRlbUxhYmVsO1xuICAgIHRoaXMucmVzdWx0c0FzSXRlbXMgPSByZXN1bHRzO1xuICAgIHRoaXMucmVzdWx0cyA9IHJlc3VsdHMubWFwKChpdGVtOiBzdHJpbmcgfCBhbnkpID0+XG4gICAgICBsYWJlbEZvckRpc3BsYXkgPyBpdGVtW2xhYmVsRm9yRGlzcGxheV0gOiBpdGVtXG4gICAgKTtcbiAgICB0aGlzLnN1Z2dlc3Rpb25JbmRleCA9IE5PX0lOREVYO1xuICAgIGlmICghcmVzdWx0cyB8fCAhcmVzdWx0cy5sZW5ndGgpIHtcbiAgICAgIHRoaXMuYWN0aXZlUmVzdWx0ID0gdGhpcy5zZWFyY2hRdWVyeTtcbiAgICB9XG4gIH1cblxuICBmaWx0ZXJFbnRlckV2ZW50KGVsZW1lbnRPYnM6IFN1YmplY3Q8S2V5Ym9hcmRFdmVudD4pIHtcbiAgICBlbGVtZW50T2JzLnBpcGUoZmlsdGVyKGlzRW50ZXJLZXkpKS5zdWJzY3JpYmUoKGV2ZW50OiBLZXlib2FyZEV2ZW50KSA9PiB7XG4gICAgICB0aGlzLmhhbmRsZVNlbGVjdFN1Z2dlc3Rpb24odGhpcy5hY3RpdmVSZXN1bHQpO1xuICAgIH0pO1xuICB9XG5cbiAgbmF2aWdhdGVXaXRoQXJyb3dzKGVsZW1lbnRPYnM6IFN1YmplY3Q8S2V5Ym9hcmRFdmVudD4pIHtcbiAgICBlbGVtZW50T2JzXG4gICAgICAucGlwZShcbiAgICAgICAgZmlsdGVyKChlOiBhbnkpID0+IHZhbGlkYXRlQXJyb3dLZXlzKGUua2V5Q29kZSkpLFxuICAgICAgICBtYXAoKGU6IGFueSkgPT4gZS5rZXlDb2RlKVxuICAgICAgKVxuICAgICAgLnN1YnNjcmliZSgoa2V5Q29kZTogc3RyaW5nKSA9PiB7XG4gICAgICAgIHRoaXMudXBkYXRlSW5kZXgoa2V5Q29kZSk7XG4gICAgICAgIHRoaXMuZGlzcGxheVN1Z2dlc3Rpb25zKCk7XG4gICAgICB9KTtcbiAgfVxuXG4gIHVwZGF0ZUluZGV4KGtleUNvZGU6IHN0cmluZykge1xuICAgIHRoaXMuc3VnZ2VzdGlvbkluZGV4ID0gcmVzb2x2ZU5leHRJbmRleChcbiAgICAgIHRoaXMuc3VnZ2VzdGlvbkluZGV4LFxuICAgICAga2V5Q29kZSA9PT0gS2V5LkFycm93RG93bixcbiAgICAgIHRoaXMucmVzdWx0cy5sZW5ndGhcbiAgICApO1xuICB9XG5cbiAgZGlzcGxheVN1Z2dlc3Rpb25zKCkge1xuICAgIHRoaXMuc2hvd1N1Z2dlc3Rpb25zID0gdHJ1ZTtcbiAgICB0aGlzLmNkci5tYXJrRm9yQ2hlY2soKTtcbiAgfVxuXG4gIHN1Z2dlc3QocXVlcnk6IHN0cmluZykge1xuICAgIHJldHVybiB0aGlzLnRhTGlzdC5sZW5ndGhcbiAgICAgID8gdGhpcy5jcmVhdGVMaXN0U291cmNlKHRoaXMudGFMaXN0LCBxdWVyeSlcbiAgICAgIDogdGhpcy5yZXF1ZXN0KHF1ZXJ5KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBwZWZvcm1zIGEganNvbnAvaHR0cCByZXF1ZXN0IHRvIHNlYXJjaCB3aXRoIHF1ZXJ5IGFuZCBwYXJhbXNcbiAgICogQHBhcmFtIHF1ZXJ5IHRoZSBxdWVyeSB0byBzZWFyY2ggZnJvbSB0aGUgcmVtb3RlIHNvdXJjZVxuICAgKi9cbiAgcmVxdWVzdChxdWVyeTogc3RyaW5nKSB7XG4gICAgY29uc3QgdXJsID0gdGhpcy50YVVybDtcbiAgICBjb25zdCBzZWFyY2hDb25maWcgPSBjcmVhdGVQYXJhbXNGb3JRdWVyeShcbiAgICAgIHF1ZXJ5LFxuICAgICAgdGhpcy50YVF1ZXJ5UGFyYW0sXG4gICAgICB0aGlzLnRhUGFyYW1zXG4gICAgKTtcbiAgICBjb25zdCBvcHRpb25zID0ge1xuICAgICAgcGFyYW1zOiBzZWFyY2hDb25maWcsXG4gICAgfTtcbiAgICBjb25zdCBpc0pzb25wQXBpID0gdGhpcy50YUFwaSA9PT0gJ2pzb25wJztcbiAgICByZXR1cm4gaXNKc29ucEFwaVxuICAgICAgPyB0aGlzLnJlcXVlc3RKc29ucCh1cmwsIG9wdGlvbnMsIHRoaXMudGFDYWxsYmFja1BhcmFtVmFsdWUpXG4gICAgICA6IHRoaXMucmVxdWVzdEh0dHAodXJsLCBvcHRpb25zKTtcbiAgfVxuXG4gIHJlcXVlc3RIdHRwKHVybDogc3RyaW5nLCBvcHRpb25zKSB7XG4gICAgY29uc3QgYXBpTWV0aG9kID0gcmVzb2x2ZUFwaU1ldGhvZCh0aGlzLnRhQXBpTWV0aG9kKTtcbiAgICByZXR1cm4gdGhpcy5odHRwW2FwaU1ldGhvZF0odXJsLCBvcHRpb25zKTtcbiAgfVxuXG4gIHJlcXVlc3RKc29ucCh1cmwsIG9wdGlvbnMsIGNhbGxiYWNrID0gJ2NhbGxiYWNrJykge1xuICAgIGNvbnN0IHBhcmFtcyA9IG9wdGlvbnMucGFyYW1zLnRvU3RyaW5nKCk7XG4gICAgcmV0dXJuIHRoaXMuaHR0cFxuICAgICAgLmpzb25wKGAke3VybH0/JHtwYXJhbXN9YCwgY2FsbGJhY2spXG4gICAgICAucGlwZShtYXAodG9Kc29ucFNpbmdsZVJlc3VsdCksIG1hcCh0b0pzb25wRmluYWxSZXN1bHRzKSk7XG4gIH1cblxuICBtYXJrSXNBY3RpdmUoaW5kZXg6IG51bWJlciwgcmVzdWx0OiBzdHJpbmcpIHtcbiAgICBjb25zdCBpc0FjdGl2ZSA9IGlzSW5kZXhBY3RpdmUoaW5kZXgsIHRoaXMuc3VnZ2VzdGlvbkluZGV4KTtcbiAgICBpZiAoaXNBY3RpdmUpIHtcbiAgICAgIHRoaXMuYWN0aXZlUmVzdWx0ID0gcmVzdWx0O1xuICAgIH1cbiAgICByZXR1cm4gaXNBY3RpdmU7XG4gIH1cblxuICBoYW5kbGVTZWxlY3Rpb25DbGljayhzdWdnZXN0aW9uOiBzdHJpbmcsIGluZGV4OiBudW1iZXIpIHtcbiAgICB0aGlzLnN1Z2dlc3Rpb25JbmRleCA9IGluZGV4O1xuICAgIHRoaXMuaGFuZGxlU2VsZWN0U3VnZ2VzdGlvbihzdWdnZXN0aW9uKTtcbiAgfVxuXG4gIGhhbmRsZVNlbGVjdFN1Z2dlc3Rpb24oc3VnZ2VzdGlvbjogc3RyaW5nKSB7XG4gICAgY29uc3QgcmVzdWx0ID0gdGhpcy5yZXN1bHRzQXNJdGVtcy5sZW5ndGhcbiAgICAgID8gdGhpcy5yZXN1bHRzQXNJdGVtc1t0aGlzLnN1Z2dlc3Rpb25JbmRleF1cbiAgICAgIDogc3VnZ2VzdGlvbjtcbiAgICB0aGlzLmhpZGVTdWdnZXN0aW9ucygpO1xuICAgIGNvbnN0IHJlc29sdmVkUmVzdWx0ID1cbiAgICAgIHRoaXMuc3VnZ2VzdGlvbkluZGV4ID09PSBOT19JTkRFWCA/IHRoaXMuc2VhcmNoUXVlcnkgOiByZXN1bHQ7XG4gICAgdGhpcy50YVNlbGVjdGVkLmVtaXQocmVzb2x2ZWRSZXN1bHQpO1xuICB9XG5cbiAgaGlkZVN1Z2dlc3Rpb25zKCkge1xuICAgIHRoaXMuc2hvd1N1Z2dlc3Rpb25zID0gZmFsc2U7XG4gIH1cblxuICBoYXNJdGVtVGVtcGxhdGUoKSB7XG4gICAgcmV0dXJuIHRoaXMudGFJdGVtVHBsICE9PSB1bmRlZmluZWQ7XG4gIH1cblxuICBjcmVhdGVMaXN0U291cmNlKGxpc3Q6IGFueVtdLCBxdWVyeTogc3RyaW5nKTogT2JzZXJ2YWJsZTxzdHJpbmdbXT4ge1xuICAgIGNvbnN0IHNhbml0aXplZFF1ZXJ5ID0gdGhpcy50YUNhc2VTZW5zaXRpdmUgPyBxdWVyeSA6IHF1ZXJ5LnRvTG93ZXJDYXNlKCk7XG4gICAgY29uc3QgZmllbGRzVG9FeHRyYWN0ID0gdGhpcy50YUxpc3RJdGVtRmllbGQ7XG4gICAgcmV0dXJuIG9mKFxuICAgICAgbGlzdC5maWx0ZXIoKGl0ZW06IHN0cmluZyB8IGFueSkgPT4ge1xuICAgICAgICByZXR1cm4gcmVzb2x2ZUl0ZW1WYWx1ZShcbiAgICAgICAgICBpdGVtLFxuICAgICAgICAgIGZpZWxkc1RvRXh0cmFjdCxcbiAgICAgICAgICB0aGlzLnRhQ2FzZVNlbnNpdGl2ZVxuICAgICAgICApLmluY2x1ZGVzKHNhbml0aXplZFF1ZXJ5KTtcbiAgICAgIH0pXG4gICAgKTtcbiAgfVxufVxuIl19